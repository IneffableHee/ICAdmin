<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>登录-惠水县一折通数据平台管理端</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta content="A fully featured admin theme which can be used to build CRM, CMS, etc." name="description" />
        <meta content="Coderthemes" name="author" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- App favicon -->
        <link rel="shortcut icon" href="assets/images/favicon.ico">

        <!-- Icons css -->
        <link href="assets/libs/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet" type="text/css" />
        <link href="assets/libs/dripicons/webfont/webfont.css" rel="stylesheet" type="text/css" />
        <link href="assets/libs/simple-line-icons/css/simple-line-icons.css" rel="stylesheet" type="text/css" />

        <!-- App css -->
        <!-- build:css -->
        <link href="assets/css/app.css" rel="stylesheet" type="text/css" />
        <!-- endbuild -->

    </head>

    <body class="bg-account-pages">

        <!-- Login -->
        <section>
            <div class="container">
                <div class="row">
                    <div class="col-12">

                        <div class="wrapper-page">
                            <div class="account-pages">
                                <div class="account-box">

                                    <!-- Logo box-->
                                    <div class="account-logo-box">
                                        <h2 class="text-uppercase text-center">
                                            <a href="index.html" class="text-success">
                                                <span><img src="assets/images/logo_dark.png" alt="" height="28"></span>
                                            </a>
                                        </h2>
                                    </div>

                                    <div class="account-content">
                                            <div class="form-group mb-3">
                                            	<span id="userTip" class="float-right" style="color: red;"><small></small></span>
                                                <label for="emailaddress" class="font-weight-medium">账号：</label>
                                                <input class="form-control" name="name" type="" id="" required="" placeholder="账号为手机号">
                                            </div>

                                            <div class="form-group mb-3 mima" id="mima" style="display: none;">
                                                <span id="pwTip" class="float-right" style="color: red;"><small></small></span>
                                                <label for="password" class="font-weight-medium">密码：</label>
                                                <input class="form-control" id="password" name="pw" type="password" required="" id="password" placeholder="输入密码">
                                            </div>
                                            
                                            <div class="form-group mb-3 yanzhengma" id="yanzhengma" style="display: none;">
                                                <span id="pwTip" class="float-right" style="color: red;"><small></small></span>
                                                <label for="password" class="font-weight-medium">验证码：</label>
                                                <div class="row" style="width: 100%;margin-left: 0px;">
                                                	<input class="form-control col-md-8" id="password" name="pw" type="password" required="" id="password" placeholder="输入手机验证码">
                                                	<div class="col-md-1"></div>
                                                	<button class="btn btn-info float-right col-md-3">获取验证码</button>
                                                </div>
                                                
                                            </div>

                                            <div class="form-group mb-3">
                                                <div class="checkbox checkbox-info">
                                                	<a href="auth-recoverpassword.html" class="text-muted float-right"><small>忘记密码</small></a>
                                                    <input id="remember" type="checkbox">
                                                    <label for="remember">
                                                        	记住密码
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="form-group row text-center">
                                                <div class="col-12">
                                                    <button class="btn btn-block btn-success waves-effect waves-light" id="submit">登 录</button>
                                                </div>
                                            </div>

                                    </div> <!-- end account-content -->

                                </div> <!-- end account-box -->
                            </div>
                            <!-- end account-page-->
                        </div>
                        <!-- end wrapper-page -->

                    </div> <!-- end col -->
                </div> <!-- end row -->
            </div> <!-- end container -->
        </section>
        <!-- END HOME -->    


        <!-- jQuery  -->
        <script src="assets/libs/jquery/jquery.min.js"></script>
        <script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/libs/jquery-slimscroll/jquery.slimscroll.min.js"></script>

        <!-- App js -->
        <script src="assets/js/jquery.core.js"></script>
        <script src="assets/js/jquery.app.js"></script>
        <script src="assets/js/base64.js" type="text/javascript" charset="utf-8"></script>
		<script>
			$(document).ready(function() {
		        $('#password').bind("cut copy paste", function(e) {
		            e.preventDefault();
		        });
		        
		        qwe = getCookie("icid");
				if(TestGuid(qwe)){	//原设备登录，不需要验证码
					$("#yanzhengma").hide();
					$("#mima").show();
				}else{		////更换设备，验证码登录
					$("#mima").hide();
					$("#yanzhengma").show();
				}
		    });
		   
			function getCookie(c_name) {
				if (document.cookie.length > 0) {
					c_start = document.cookie.indexOf(c_name + "=")
					if (c_start != -1) {
						c_start = c_start + c_name.length + 1
						c_end = document.cookie.indexOf(";", c_start)
						if (c_end == -1) c_end = document.cookie.length
						return unescape(document.cookie.substring(c_start, c_end))
					}
				}
				return null;
			}
			
			//验证Guid形式
			function TestGuid(testID) {
			  var reg = new RegExp(/^[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}$/);
			  if (reg.test(testID)) {
			      return true;
			  }
			  return false;
			}
		    
			$("#submit").click(function (){ 
				var userName = $("input[name='name']").val();
				var userPw = $("input[name='pw']").val();
				var b = new Base64();
				var icid = getCookie("icid");
				if(!checkLogin(userName,userPw)){
					return;
				}
				$.ajax({
						url: "http://localhost:8080/icdata/admin",        
						data: {                          
							username:userName,
							password:b.encode(userPw),
							guid:icid
						},
						type: "POST",                  
						dataType: 'json',              
						success: function (data) {      
							result=JSON.parse(data);
							if(result.icid != icid){
									document.cookie="icid"+"="+result.icid;
								}
							document.cookie=result.token.substring(0,20)+"="+result.token;
							if(result.status==0){	  //状态为0,修改默认密码
								window.location.href="auth-recoverpassword.html?hid="+result.token.substring(0,20);
							}else if(result.status==1){		//状态为1,直接登陆
								window.location.href="index.html?hid="+result.token.substring(0,20);
							}else if(result.status==2){ //状态为2,需输入手机验证码
								window.location.href="auth-yanzhengma.html?hid="+result.token.substring(0,20);
							}else{	//其他错误提示信息
								$("#userTip").text(result.msg);
							}
						},
						error: function (er) {    
							$("#userTip").text("未知错误，请检查网络或联系管理员！");
//							alert(JSON.stringify(er));
						}
					});
				
        })
			
		function checkLogin(name,password){
//			if(name==""){
//				$("#userTip").text("请输入用户名");
//				return false;
//			}else if(isPhoneNo($.trim(name)) == false){
//				$("#userTip").text("请输入正确的账号");
//				return false;
//			}else{
//				$("#userTip").text("");
//			}
//			var reqPassword =/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{8,16}$/;
//			if(password == ""){
//				$("#pwTip").html("请输入密码");
//				return false;
//			}else if (reqPassword.test(password)) {	
//				$("#pwTip").html("");
//              return true;
//          }else {
//               $("#pwTip").html("密码错误");
//               return false;
//          }
			if(name==""){
				$("#userTip").text("请输入用户名");
				return false;
			}else{
				$("#userTip").text("");
			}
			if(password == ""){
				$("#pwTip").html("请输入密码");
				return false;
			}else if (password.length>=6&&password.length<=16) {
				$("#pwTip").html("");
                return true;
            }else {
                 $("#pwTip").html("密码错误");
                 return false;
            }
		}
		
		// 验证手机号
		function isPhoneNo(phone) {
		    var pattern = /^1[34578]\d{9}$/;
		    return pattern.test(phone);
		}
		
		function guid() {
		    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
		        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
		        return v.toString(16);
		    });
		}
		
		</script>
    </body>
</html>
