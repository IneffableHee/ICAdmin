<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Greeva - Responsive Bootstrap 4 Admin Dashboard</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta content="A fully featured admin theme which can be used to build CRM, CMS, etc." name="description" />
        <meta content="Coderthemes" name="author" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- App favicon -->
        <link rel="shortcut icon" href="assets/images/favicon.ico">

        <!-- Icons css -->
        <link href="assets/libs/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet" type="text/css" />
        <link href="assets/libs/dripicons/webfont/webfont.css" rel="stylesheet" type="text/css" />
        <link href="assets/libs/simple-line-icons/css/simple-line-icons.css" rel="stylesheet" type="text/css" />

        <!-- App css -->
        <!-- build:css -->
        <link href="assets/css/app.css" rel="stylesheet" type="text/css" />
        <!-- endbuild -->

    </head>

    <body class="bg-account-pages">

        <!-- HOME -->
        <section>
            <div class="container">
                <div class="row">
                    <div class="col-12">

                        <div class="wrapper-page">
                            <div class="account-pages">
                                <div class="account-box">
                                    <!-- Logo Box -->
                                    <div class="account-logo-box">
                                        <h2 class="text-uppercase text-center">
                                            <a href="index.html" class="text-success">
                                                <span><img src="assets/images/logo_dark.png" alt="" height="28"></span>
                                            </a>
                                        </h2>
                                    </div>

                                    <div class="account-content">
                                            <div class=" mb-3 text-center">
                                                <p class="text-muted m-b-0 font-19">由于您使用默认密码登录，为了您的账户安全，请验证手机号并修改密码！</p>
                                            </div>
                                            
                                            <div class=" mb-3">
                                                <label class="font-weight-medium">手机号：</label>
                                                <span id="telTip" class="text-center msgTip"><small>*账号绑定的手机号</small></span>
                                                <input class="form-control" type="tel" id="telnumber" placeholder="输入账号绑定的手机号">
                                            </div>
                                            
											<div class="mb-3">
                                                <label class="font-weight-medium">验证码:</label>
                                                <span id="yzTip" class="text-center msgTip"><small>*请通过账户绑定手机号获取验证码</small></span>
                                                <div class="row" style="width: 100%;margin-left: 0px;">
                                                	<input class="form-control col-md-8" style="height: 80%;" id="verify" placeholder="6位数验证码">
                                                	<div class="col-md-1"></div>
                                                	<label class="btn btn-info float-right col-md-3" id="getyanzhengma">获取验证码</label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="font-weight-medium">设置新密码：</label>
                                                <span id="pwTip" class="text-center msgTip" ><small>*新密码为6-18位字母、数字组合</small></span>
                                                <input class="form-control" type="password" id="password" required="" placeholder="6-18位字母、数字组合">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="font-weight-medium">确认密码：</label>
                                                <span id="ckpwTip" class="text-center msgTip"><small>*请确认密码</small></span>
                                                <input class="form-control" type="password" id="ckpassword" required="" placeholder="6-18位字母、数字组合">
                                            </div>

                                            <div class="row text-center">
                                                <div class="col-12">
                                                    <button class="btn btn-block btn-success waves-effect waves-light" id="submit">确 认</button>
                                                </div>
                                            </div>

                                        <div class="row mt-3">
                                            <div class="col-12 text-center">
                                                <p class="text-muted"><a href="auth-login.html" class="text-dark m-l-5">切换账号 ></a></p>
                                            </div>
                                        </div> <!-- end row -->

                                    </div> <!-- end account-content -->

                                </div> <!-- end account-box -->
                            </div>
                            <!-- end account-page-->
                        </div>
                        <!-- end wrapper-page -->

                    </div> <!-- end col -->
                </div> <!-- end row -->
            </div> <!-- end container -->
        </section>
        <!-- END HOME -->    


        <!-- jQuery  -->
        <script src="assets/libs/jquery/jquery.min.js"></script>
        <script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/libs/jquery-slimscroll/jquery.slimscroll.min.js"></script>

        <!-- App js -->
        <script src="assets/js/jquery.core.js"></script>
        <script src="assets/js/jquery.app.js"></script>
		<script>
			
			$(document).ready(function() {
				$(".msgTip").css({color:"#02A8B5"});
				var hid = getUrlParam('hid');
//				alert("hid"+hid);
				var pid = getCookie(hid);
//				alert("pid"+pid);
				var guid = getCookie("guid");
//				alert("guid"+guid);
//				if(pid==null){
//					window.location.href="auth-login.html";
//					return;
//				}else if(guid==null){
//					window.location.href="auth-login.html";
//					return;
//				}

			});
			
			$("#telnumber").on('focus',function(){
                $("#telTip").css({color:"#02A8B5"});;
				$("#telTip").text("*账号绑定的手机号！");
            })
			$("#verify").on('focus',function(){
                $("#yzTip").css({color:"#02A8B5"});;
				$("#yzTip").text("*账号绑定的手机号！");
            })
			$("#password").on('focus',function(){
                $("#pwTip").css({color:"#02A8B5"});;
				$("#pwTip").text("*新密码为6-18位字母、数字组合！");
            })
			$("#ckpassword").on('focus',function(){
                $("#ckpwTip").css({color:"#02A8B5"});;
				$("#ckpwTip").text("*请确认密码！");
            })
			
			$("#getyanzhengma").click(function (){
				if($("#getyanzhengma").html().trim().indexOf("重新发送") != -1){
					return;
				}
				var tel = $("#telnumber").val();
				if(!isPhoneNo(tel)){
					$("#telTip").css({color:"red"});
					$("#telTip").text("*请输入正确的手机号码！");
					return;
				}
				$.ajax({
						url: "http://localhost:8080/icdata/verify/get",        
						data: {                          
							tel:tel
						},
						type: "POST",                  
						dataType: 'json',              
						success: function (data) {  
//							alert(JSON.stringify(data));
							result=JSON.parse(data);
							if(result.status==4){	  //状态为4,发送失败
								$("#yzTip").text("*"+result.msg.toString());
								$("#yzTip").css({color:"red"});
							}else{
								var countdown = 60;
								settime(countdown);
							}
						},
						error: function (er) { 
							$("#yzTip").text("*未知错误，请检查网络或联系管理员！");
							$("#yzTip").css({color:"red"});
						}
					});
			})
			
			$("#submit").click(function (){ 
				var tel = $("#telnumber").val();
				if(!isPhoneNo(tel)){
					$("#telTip").css({color:"red"});
					$("#telTip").text("*请输入正确的手机号码！");
					return;
				}
				
				if(!/^\d{6}$/.test($("#verify").val())){
					$("#yzTip").css({color:"red"});
					$("#yzTip").text("*请输入正确的验证码！");
					return;
				}
				
				if(!checkPass()){
					return;
				}
				
				var b = new Base64();
				$.ajax({
						url: "http://localhost:8080/icdata/admin",        
						data: {                          
							tel:tel,
							password:b.encode($("#password").val()),
							verify:$("#verify").val())
						},
						type: "POST",                  
						dataType: 'json',              
						success: function (data) {      
							result=JSON.parse(data);
							alert(JSON.stringify(data));
//							if(result.status==0){	  //状态为0,修改默认密码
//								document.cookie=result.token.substring(0,20)+"="+result.token;
//								if(result.guid != guid)
//									document.cookie="guid"+"="+result.guid;
//								window.location.href="auth-recoverpassword.html?hid="+result.token.substring(0,20);
//							}else if(result.status==1){		//状态为1,直接登陆
//								document.cookie=result.token.substring(0,20)+"="+result.token;
//								if(result.guid != guid)
//									document.cookie="guid"+"="+result.guid;
//								window.location.href="index.html?hid="+result.token.substring(0,20);
//							}else if(result.status==2){ //状态为2,更换设备需输入手机验证码
//								document.cookie=result.token.substring(0,20)+"="+result.token;
//								if(result.guid != icid)
//									document.cookie="guid"+"="+result.guid;
//								window.location.href="auth-yanzhengma.html?hid="+result.token.substring(0,20);
//							}else if(result.status==3){	//其他错误提示信息
//								if(result.msg.indexOf("密码") != -1)
//									$("#pwTip").text(result.msg.toString());
//								else
//									$("#userTip").text(result.msg.toString());
//							}
						},
						error: function (er) {    
							$("#userTip").text("未知错误，请检查网络或联系管理员！");
//							alert(JSON.stringify(er));
						}
					});
			})
			
			function settime(countdown) {	
				x=document.getElementById("getyanzhengma");
		        if (countdown == 0) {
		            $("#getyanzhengma").attr("disabled",false);
		            $("#getyanzhengma").html("获取验证码");
		        } else {
		            $("#getyanzhengma").attr("disabled", true);
		            x.innerHTML="重新发送(" + countdown + ")";
		            countdown--;
		            setTimeout(function() {
		                settime(countdown);
		            },1000)
		        }
		    }
			
			function checkPass(){
				var password = $("#password").val();
				var ckpassword = $("#ckpassword").val();
				var reqPassword =/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{8,16}$/;
				if(password == ""){
					$("#pwTip").css({color:"red"});
					$("#pwTip").html("*请输入密码");
					return false;
				}else if (ckpassword == ""){
					$("#ckpwTip").css({color:"red"});
					$("#ckpwTip").html("*请确认密码");
					return false;
				}else if (password!=ckpassword){
					$("#ckpwTip").css({color:"red"});
					$("#ckpwTip").html("*两次密码不相等");
					return false;
				}
				if(reqPassword.test(password)) {
					$("#pwTip").html("");
					$("#ckpwTip").html("");
	                return true;
	            }else {
	            	$("#pwTip").css({color:"red"});
	                 return false;
	            }
	
			}
			
			function getCookie(c_name) {
				if (document.cookie.length > 0) {
					c_start = document.cookie.indexOf(c_name + "=")
					if (c_start != -1) {
						c_start = c_start + c_name.length + 1
						c_end = document.cookie.indexOf(";", c_start)
						if (c_end == -1) c_end = document.cookie.length
						return unescape(document.cookie.substring(c_start, c_end))
					}
				}
				return null;
			}
			
			function getUrlParam(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r != null) {
					return unescape(r[2]);
				} else {
					return null;
				}
			}
			
			// 验证手机号
			function isPhoneNo(phone) {
			    var pattern = /^1[34578]\d{9}$/;
			    return pattern.test(phone);
			}
		</script>
    </body>
</html>
